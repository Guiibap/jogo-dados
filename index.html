<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Jogo de Dados Multiplayer - Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, onChildAdded, remove, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZMZKT8rse5Vbd_ql2PmScrw2KwwsXCjk",
      authDomain: "jogo-dados.firebaseapp.com",
      databaseURL: "https://jogo-dados-default-rtdb.firebaseio.com",
      projectId: "jogo-dados",
      storageBucket: "jogo-dados.firebasestorage.app",
      messagingSenderId: "187282881305",
      appId: "1:187282881305:web:802bbae9d1e34a23062388",
      measurementId: "G-45FT045HY9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentRoom = null;
    let currentUser = null;
    let isHost = false;

    function createRoom(username) {
      const roomId = 'sala-' + Math.random().toString(36).substring(2, 8);
      const roomRef = ref(db, 'rooms/' + roomId);
      currentRoom = roomId;
      currentUser = username;
      isHost = true;

      set(roomRef + '/users/' + username, true);
      window.location.hash = roomId;
      document.getElementById('room-id').textContent = roomId;
      listenToRoom(roomId);
    }

    function joinRoom(username, roomId) {
      const userRef = ref(db, 'rooms/' + roomId + '/users/' + username);
      currentRoom = roomId;
      currentUser = username;
      isHost = false;

      set(userRef, true);
      document.getElementById('room-id').textContent = roomId;
      listenToRoom(roomId);
    }

    function listenToRoom(roomId) {
      const usersRef = ref(db, 'rooms/' + roomId + '/users');
      const historyRef = ref(db, 'rooms/' + roomId + '/history');

      onValue(usersRef, (snapshot) => {
        const users = snapshot.val() || {};
        const userList = document.getElementById('user-list');
        userList.innerHTML = '';
        Object.keys(users).forEach(name => {
          const li = document.createElement('li');
          li.textContent = name;
          userList.appendChild(li);
        });
      });

      onChildAdded(historyRef, (snapshot) => {
        const { username, value1, value2, total } = snapshot.val();
        const history = document.getElementById('history');
        const p = document.createElement('p');
        p.textContent = `${username} rolou ${value1} + ${value2} = ${total}`;
        history.appendChild(p);
        document.getElementById('dice').textContent = `ðŸŽ² ${value1} + ${value2} = ${total}`;
      });
    }

    function rollDice() {
      const value1 = Math.floor(Math.random() * 6) + 1;
      const value2 = Math.floor(Math.random() * 6) + 1;
      const total = value1 + value2;

      const rollRef = push(ref(db, 'rooms/' + currentRoom + '/history'));
      set(rollRef, {
        username: currentUser,
        value1,
        value2,
        total,
        timestamp: Date.now()
      });
    }

    window.onload = () => {
      document.getElementById('create-room').onclick = () => {
        const name = prompt('Seu nome:');
        if (name) createRoom(name);
      };

      document.getElementById('join-room').onclick = () => {
        const name = prompt('Seu nome:');
        const roomId = prompt('ID da sala:');
        if (name && roomId) joinRoom(name, roomId);
      };

      document.getElementById('roll').onclick = () => {
        if (currentRoom && currentUser) rollDice();
        else alert('Entre em uma sala primeiro');
      };
    };
  </script>
</head>
<body class="bg-gray-900 text-white text-center p-8 space-y-6">
  <h1 class="text-3xl font-bold">ðŸŽ² Jogo de Dados Multiplayer</h1>
  <p>ID da sala: <span id="room-id" class="text-yellow-300">nenhuma</span></p>
  <div class="flex justify-center gap-4">
    <button id="create-room" class="bg-green-600 px-4 py-2 rounded">Criar Sala</button>
    <button id="join-room" class="bg-blue-600 px-4 py-2 rounded">Entrar na Sala</button>
  </div>
  <button id="roll" class="bg-yellow-500 px-6 py-3 rounded text-black font-bold text-xl">Rolar Dados</button>
  <div id="dice" class="text-2xl mt-4">ðŸŽ² ?</div>
  <div class="mt-6">
    <h2 class="text-lg font-semibold">Jogadores na sala:</h2>
    <ul id="user-list" class="space-y-1"></ul>
  </div>
  <div class="mt-6">
    <h2 class="text-lg font-semibold">HistÃ³rico:</h2>
    <div id="history" class="space-y-1"></div>
  </div>
</body>
</html>
